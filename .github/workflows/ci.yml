name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Fast tests only
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-timeout

      - name: Pytest sanity
        run: |
          python -c "import pytest, sys; print('pytest ok')"

      - name: Pytest discovery
        run: |
          pytest -q --collect-only tests > .pytest_collect.txt || true
          echo 'Collected:'
          head -50 .pytest_collect.txt
          grep -E "collected [1-9][0-9]* items" .pytest_collect.txt || (echo "No tests collected" && exit 1)

      - name: Run fast unit tests (no API calls)
        run: |
          # Run only pure unit tests that don't require external API calls
          pytest -q -x --timeout=30 \
            tests/test_pure_functions.py \
            tests/test_allocate.py \
            tests/test_edge_cases.py \
            tests/test_feature_registry.py \
            tests/test_contracts.py \
            tests/test_ml_contract_latest.py

      - name: Verify core imports
        run: |
          python -c "
from core.config import get_config
from core.data import fetch_price_multi_source
from core.scoring import compute_technical_score
from core.price_verify import fetch_prices_for_ticker
from app_config import CONFIG
print('âœ“ All core imports verified')
          "
