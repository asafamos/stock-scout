name: ML A2 Contract

on:
  push:
    paths:
      - 'core/**'
      - 'scripts/**'
      - 'tests/**'
      - '.github/workflows/ml-a2-contract.yml'
  workflow_dispatch:

jobs:
  validate-ml-a2:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Pytest sanity
        run: |
          python -c "import pytest, sys; print('pytest ok')"

      - name: Pytest discovery
        run: |
          pytest -q --collect-only tests > .pytest_collect.txt || true
          echo 'Collected:'
          cat .pytest_collect.txt
          grep -E "collected [1-9][0-9]* items" .pytest_collect.txt || (echo "No tests collected" && exit 1)

      - name: Run contract and smoke tests
        run: |
          pytest -q tests

      - name: Validate feature registry contract
        run: |
          python - << 'PY'
          from core.feature_registry import get_feature_names, FEATURE_COUNT_V3

          # Validate feature registry
          features = get_feature_names("v3")
          assert len(features) == FEATURE_COUNT_V3, f"Expected {FEATURE_COUNT_V3} features, got {len(features)}"

          # Check critical features exist
          critical_features = ['RSI', 'ATR_Pct', 'Return_20d', 'Volume_Surge', 'Dist_From_52w_High', 'MA_Alignment']
          for feat in critical_features:
              assert feat in features, f"Critical feature missing: {feat}"

          print(f"✅ Feature registry validated: {len(features)} features")
          PY

      - name: Validate existing model bundle (if present)
        run: |
          python - << 'PY'
          import os
          import joblib
          from pathlib import Path

          model_path = Path('models/model_20d_v3.pkl')
          if not model_path.exists():
              print("ℹ️  No model bundle found - skipping validation")
              exit(0)

          bundle = joblib.load(model_path)
          assert isinstance(bundle, dict), "Bundle must be a dict"
          assert 'model' in bundle, "Bundle must contain 'model'"
          assert 'feature_names' in bundle, "Bundle must contain 'feature_names'"

          feats = bundle.get('feature_names', [])
          print(f"✅ Model bundle validated: {len(feats)} features")

          # Validate metrics if present
          if 'metrics' in bundle:
              metrics = bundle['metrics']
              print(f"   OOS AUC: {metrics.get('oos_auc_mean', 'N/A')}")
              print(f"   P@20: {metrics.get('precision_at_20_mean', 'N/A')}")
          PY
